name: Auto update manifest.json from HTML

on:
  push:
    branches: [ "main" ]
    paths:
      - "study_timer_latest.html"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-manifest:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Extract APP_VERSION and UPDATE_NOTES from HTML
        run: |
          python3 - << 'PY'
          import re, json, pathlib

          html = pathlib.Path("study_timer_latest.html").read_text(encoding="utf-8", errors="ignore")

          def find(p):
            m = re.search(p, html)
            return m.group(1).strip() if m else ""

          version = find(r'APP_VERSION\s*=\s*["\']([^"\']+)["\']')
          notes   = find(r'UPDATE_NOTES\s*=\s*["\']([^"\']+)["\']')

          if not version:
            raise SystemExit("APP_VERSION not found")

          manifest = {
            "latest": version,
            "url": "https://happynuri-codefair.github.io/study-timer-update/study_timer_latest.html",
            "notes": notes
          }

          pathlib.Path("manifest.json").write_text(
            json.dumps(manifest, ensure_ascii=False, indent=2),
            encoding="utf-8"
          )
          PY

      - name: Commit and push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add manifest.json
          if git diff --cached --quiet; then
            echo "No changes"
            exit 0
          fi
          git commit -m "chore: auto update manifest.json"
          git push
